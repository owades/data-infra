name: Build release candidate

on:
  push:
    paths:
      - '.holo/**'
      - 'kubernetes/apps/**'
      - 'kubernetes/system/**'


env:
  GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
  BIO_RELEASE: 1.6.372


jobs:
  build-release-candidate:
    if: ${{ github.repository == 'cal-itp/data-infra' && ( github.ref == 'refs/heads/main' || startswith(github.ref, 'refs/tags/candidates/') ) }}
    runs-on: ubuntu-latest
    steps:

    - name: Check out repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: 'Build branch: releases/candidate'
      run: |

        # dependency setup
        curl -LO "https://github.com/biome-sh/biome/releases/download/v1.6.372/bio-$BIO_RELEASE-x86_64-linux.tar.gz"
        tar xzvf "bio-$BIO_RELEASE-x86_64-linux.tar.gz"
        sudo mv bio /usr/local/bin/bio
        sudo bio pkg install jarvus/hologit
        sudo bio pkg binlink jarvus/hologit

        # branch setup
        if [[ $(git ls-remote origin refs/heads/releases/candidate) ]] && [[ ! $(git show-ref refs/remotes/origin/releases/candidate) ]]; then
          git fetch origin releases/candidate
          if [[ ! $(git show-ref refs/heads/releases/candidate) ]]; then
            git branch releases/candidate origin/releases/candidate
          fi
        fi

        # build & push
        git holo project releases/candidate --commit-to releases/candidate --commit-message "Release candidate: $(basename "$GITHUB_REF")"
        git push origin releases/candidate
